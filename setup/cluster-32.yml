# Template for setting up TissueMAPS in a multi-node environment on an OpenStack
# cloud.
#
---
cloud:
  provider: os
  region: RegionOne
  network: tmaps
  ip_range: 10.65.4.0/24
  key_name: tmaps_setup

architecture:
  name: &name cluster-32
  clusters:

    - name: slurm
      node_types:
        - name: frontend
          count: 1
          groups:
            - name: tissuemaps_server
              vars:
                cluster_mode: yes
                tm_compute_cores: 32
                tm_compute_memory: 128000
                storage_directory: /glusterfs
                tm_users:
                  - name: mustermann
                    password: XXX
                    email: ''
            - name: slurm_master
              vars:
                multiuser_cluster: no
                slurm_cluster_users:
                  - tissuemaps
            - name: glusterfs_client
            - name: ganglia_monitor
              vars:
                ganglia_cluster_name: *name
          instance:
            image: CentOS 7.3.1611 (2017-05-19)
            ssh_user: centos
            assign_public_ip: yes
            flavor: 4cpu-16ram-hpc
            tags:
              - web
              - compute

        - name: worker
          count: 8
          groups:
            - name: tissuemaps_compute
              vars:
                storage_directory: /glusterfs
            - name: slurm_worker
              vars:
                multiuser_cluster: no
            - name: glusterfs_client
            - name: ganglia_monitor
              vars:
                ganglia_cluster_name: performance
          instance:
            image: CentOS 7.3.1611 (2017-05-19)
            ssh_user: centos
            assign_public_ip: no
            flavor: 4cpu-16ram-hpc
            tags:
              - compute

    - name: postgresql
      node_types:
        - name: master
          count: 1
          groups:
            - name: tissuemaps_db_master
              vars:
                db_master_cores: 4
                db_master_memory: 16000
            - name: ganglia_monitor
              vars:
                ganglia_cluster_name: performance
          instance:
            image: CentOS 7.3.1611 (2017-05-19)
            ssh_user: centos
            assign_public_ip: no
            flavor: 4cpu-16ram-hpc
            volume_size: 500
            tags:
              - storage

        - name: worker
          count: 2
          groups:
            - name: tissuemaps_db_worker
              vars:
                db_worker_cores: 4
                db_worker_memory: 16000
            - name: ganglia_monitor
              vars:
                ganglia_cluster_name: performance
          instance:
            image: CentOS 7.3.1611 (2017-05-19)
            ssh_user: centos
            assign_public_ip: no
            flavor: 4cpu-16ram-hpc
            volume_size: 1000
            tags:
              - storage

    - name: glusterfs
      node_types:
        - name: server
          count: 2
          groups:
            - name: glusterfs_server
            - name: ganglia_monitor
              vars:
                ganglia_cluster_name: performance
          instance:
            image: CentOS 7.3.1611 (2017-05-19)
            ssh_user: centos
            assign_public_ip: no
            flavor: 4cpu-16ram-hpc
            volume_mountpoint: /srv/glusterfs
            volume_size: 1000
            tags:
              - storage

    - name: ganglia
      node_types:
        - name: server
          count: 1
          groups:
            - name: ganglia_master
              vars:
                ganglia_cluster_name: performance
                ganglia_grid_name: tissuemaps
          instance:
            image: CentOS 7.3.1611 (2017-05-19)
            ssh_user: centos
            assign_public_ip: yes
            flavor: 2cpu-2ram-server
            tags:
              - web
              - compute
